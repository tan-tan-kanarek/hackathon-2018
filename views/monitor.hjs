<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="stylesheets/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script type="text/javascript">
		let socket;	
		

		function init() {
			socket = io();

			socket.on('connect', function() {
				console.log('Socket.io connected');
				follow();
			});

			socket.on('error', function(err) {
				console.error('Socket.io error:', err);
			});

			socket.on('errorMessage', function(err) {
				console.error(err);
			});

			socket.on('motion-start', function(time) {
				console.log('motion-start');
				addEvent('Motion detected' + time);
				$('#kaltura_player').addClass('alert');
			});

			socket.on('motion-end', function(time) {
				console.log('motion-end');
				addEvent('Motion stopped' + time);
				$('#kaltura_player').removeClass('alert');
			});

			socket.on('new-event', function(eventData) {
				console.log('new-event', eventData);
				addEvent(eventData.name + ' ' + eventData.action + ' ' + eventData.time);
				$('#kaltura_player').removeClass('alert');
			});
		}
		
		function addEvent(txt) {
			$('#eventsLog').prepend('<div class="event-log-item"><div class="event-circle grab-color"></div><span>' + txt + '</span><span class="time">04:55pm</span></div>');
		}

		function follow() {
			send('follow', "{{entryId}}");
		}

		function send(type, data) {
			console.log('Sending [' + type + ']: ', data);
			socket.emit(type, data);
		}

    	$(function() {
    		init();
    	});

    </script>
    <title>Index</title>
</head>
<body>
    <div class="top-bar">
        <i class="material-icons">arrow_back</i> 
        {{#category}}{{name}}{{/category}}
    </div>
    <div class="container">
        <div class="row">
            <div class="col-6" style="height: calc(100vh - 60px); overflow-y: auto;">
                <div class="camera-container">
                    <div class="camera-container-inner">
                        <span>Live stream</span>
                        <div class="live-badge">LIVE</div>
                        {{#entry}}
                            <script src="https://cdnapisec.kaltura.com/p/{{partnerId}}/sp/{{partnerId}}00/embedIframeJs/uiconf_id/41356661/partner_id/{{partnerId}}?autoembed=true&entry_id={{id}}&playerId=kaltura_player&cache_st=1514921699&width=400&height=333&flashvars[streamerType]=auto"></script>
                        {{/entry}}
                    </div>
                </div>
            </div>
            <div class="col-6" style="height: calc(100vh - 60px); overflow-y: auto;">
                <div class="events-log">
                    {{#events}}
                        <div class="event-log-item">
                            {{#item}} 
                                <span>{{name}} {{action}}</span>
                            {{/item}}
                            <span class="time">{{time}}</span>
                        </div>
                    {{/events}}
                </div>
            </div>
        </div>
        <div class="row events-clips-container">
            <div class="clip-container">
                <div class="ratio-keeper-clip"></div>
                <div class="clip-container-dot green"></div>
                <div class="processing">Processing...</div>
            </div>
            <div class="clip-container">
                <div class="ratio-keeper-clip"></div>
                <div class="clip-container-dot green"></div>
            </div>
            <div class="clip-container">
                <div class="ratio-keeper-clip"></div>
                <div class="clip-container-dot"></div>
            </div>
            <div class="clip-container">
                <div class="ratio-keeper-clip"></div>
                <div class="clip-container-dot"></div>
            </div>
        </div>
    </div>
</body>
</html>